<!DOCTYPE html>
<!--[if IE 8]>
<html class="ie8" lang="zh">
<![endif]-->
<!--[if !(IE 8) ]><!-->
<html lang="zh"><!--<![endif]-->
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>翼图南</title>
        <link rel ="alternate" type="application/atom+xml"
                               title="翼图南 — Flux RSS"
                               href="https://wing2south.com/feeds/all.atom.xml" />
      <link rel="stylesheet" id="graphy-fonts-css" href="http://fonts.proxy.ustclug.org/css?family=Lato:400,700,400italic,700italic|Bitter:400&amp;subset=latin,latin-ext" type="text/css" media="all">
      <link rel="stylesheet" id="graphy-genericons-css" href="https://wing2south.com/theme/css/genericons.css" type="text/css" media="all">
      <link rel="stylesheet" href="https://wing2south.com/theme/css/style.min.css?1571737423.0">
      <link rel="stylesheet" href="https://wing2south.com/theme/css/typo.css?1571737423.0" type="text/css" media="all">

      <link rel="apple-touch-icon" sizes="57x57" href="/theme/icons/apple-touch-icon-57x57.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/theme/icons/apple-touch-icon-60x60.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/theme/icons/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/theme/icons/apple-touch-icon-76x76.png">
      <link rel="apple-touch-icon" sizes="114x114" href="/theme/icons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/theme/icons/apple-touch-icon-120x120.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/theme/icons/apple-touch-icon-144x144.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/theme/icons/apple-touch-icon-152x152.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/theme/icons/apple-touch-icon-180x180.png">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-32x32.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/theme/icons/android-chrome-192x192.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-16x16.png" sizes="16x16">
      <link rel="manifest" href="/theme/icons/manifest.json">
      <link rel="shortcut icon" href="/theme/icons/favicon.ico">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="msapplication-TileImage" content="/theme/icons/mstile-144x144.png">
      <meta name="msapplication-config" content="/theme/icons/browserconfig.xml">
      <meta name="theme-color" content="#ffffff">
  </head>


  <body class="home blog no-sidebar footer-0 has-avatars">
    <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
        <div class="site-branding">
          <h1 class="site-title"><a href="/" rel="home">翼图南</a></h1>
          <div class="site-description">故九萬里，則風斯在下矣，而後乃今培風；背負青天而莫之夭閼者，而後乃今將圖南</div>
        </div>

        <div class="main-navigation-wrapper">
          <nav id="site-navigation" class="main-navigation" role="navigation">
            <h1 class="menu-toggle">Menu</h1>
            <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
            <div class="menu">
              <ul>
                <li class="current_page_item">
                  <a href="/">Home</a>
                </li>
                    <li><a href="https://wing2south.com/pages/gpg.html">GPG</a></li>
                  <li><a href="/cv.htm">CV</a></li>
                <li class="page_item page_item_has_children">
                  <a href="#">Categories</a>
                  <ul class="children">
                      <li class="page_item">
                        <a href="/category/code.html">Code</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/devops.html">Devops</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/django.html">Django</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/fen-xiang-lian-jie.html">分享链接</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/ji-qi-xue-xi.html">机器学习</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/machinelearning.html">MachineLearning</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/others.html">Others</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/productivity.html">Productivity</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/python.html">Python</a>
                      </li>
                  </ul>
                </li>
                <li class="page_item">
                  <a href="/tags.html">Tags</a>
                </li>
                <li class="page_item page_item_has_children">
                  <a href="#">Social</a>
                  <ul class="children">
                      <li class="page_item">
                        <a href="https://twitter.com/glasslion">Twitter</a>
                      </li>
                      <li class="page_item">
                        <a href="https://github.com/glasslion">GitHub</a>
                      </li>
                      <li class="page_item">
                        <a href="http://stackoverflow.com/users/1093020/leonardo-z">StackOverflow</a>
                      </li>
                      <li class="page_item">
                        <a href="/images/wechat.jpg">微信二维码</a>
                      </li>
                  </ul>
                </li>
                  <li class="page_item">
                    <a href="https://wing2south.com/feeds/all.atom.xml" rel="alternate">Feed</a>
                  </li>
              </ul>
            </div><!-- .menu -->
            <form role="search" method="get" class="search-form" onsubmit="return google_search()">
            <label>
              <span class="screen-reader-text">Search for:</span>
              <input type="search" class="search-field" placeholder="Search …" value="" name="q" id="google_q" title="Search for:">
            </label>
            <input type="submit" class="search-submit" value="Search">
          </form>
          </nav><!-- #site-navigation -->
        </div>
      </header><!-- #masthead -->

      <div id="content" class="site-content">
        <div id="primary" class="content-area">
          <main id="main" class="site-main" role="main">

  <article class="post hentry typo">
    <header class="entry-header">
      <h1 class="entry-title">用 Travis CI 定制多样化的 Python 测试环境</h1>
        <div class="entry-meta">
          <span class="posted-on">Posted on 
            <a href="https://wing2south.com/archives/2014/11/" rel="bookmark">
              <time class="entry-date published" datetime="2014-11-13T20:06:00+08:00">Nov 13, 2014</time>
            </a>
          </span>
          <span class="byline">by 
            <span class="author vcard">
              <a class="url fn n" href="https://wing2south.com/post/travisci-multi-python-test-env/">Leonardo Zhou</a>
            </span>
          </span>
          <span class="comments-link">· <a href="https://wing2south.com/post/travisci-multi-python-test-env/#comments" title="Comment on More Tags">Leave a comment</a>
          </span>
        </div><!-- .entry-meta -->
    </header>

    <div class="entry-content">
      <p><a href="https://travis-ci.org/">Travis CI</a> 是一项面向 GitHub 用户的持续集成即测试服务。只要是在 GitHub 上开源的项目，经过简单配置， 便可以利用 Travis CI 来进行自动化测试。</p>
<p>做过 Python 开源项目开发的大概都曾被和特定 Python 版本相关的 bug 叮过。  现在比较主流的 Python 运行环境就有: Python 2.6, Python 2.7, Python 3.3 和 Python 3.4 这四种。 此外由于 CPython 有GIL 的限制,  近两年来，pypy 也得到了越来越多的关注。尽管目前 Python 3， pypy 在实际产品中还用得比较少， 但对 Python3 的支持已经成为大家在选择第三方库时需要考量的一个相当重要指标。</p>
<p>如果是做 Django 开发的话， 测试环境多样化的问题就更加严重了。现在大部分 Django 第三方库都会支持 Django 1.4 -1.7 这 4个版本。和上面提到的 4个 Python 版本组合起来，就有 16种之多( 由于 Django 1.5 以上才支持 Python3, 实际有效的组合会略少）。对于某些项目， 甚至要考虑不同数据库 （MySQL, PostgreSQL, SQLite) 的差异， 那么总的测试环境数又要 X3。</p>
<p>尽管通过 <a href="https://github.com/yyuu/pyenv">pyenv</a> 和 <a href="http://tox.readthedocs.org/en/latest/">tox</a> 这些工具,  在本地安装和测试多版本的 Python 的流程已经被简化了很多。但光是在十几个环境里把测试一一跑一遍就要花费不少时间。从而导致了我们在平时的开发过程中不会经常去运行这些测试。缺乏测试又会让我们无法尽早发现bug。像 unicode/string 相关 bug， 常常是牵一发而动全身， 后期修复的代价比较高。</p>
<p>Travis CI 使用 GitHub 项目根目录下的 <code>.travis.yml</code> 作为其配置文件。从后缀名就可以看出， 其配置文件是 <code>YAML</code> 格式的。</p>
<p>一个简单的例子：</p>
<div class="highlight snippet"><pre><span></span><span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.7&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.6&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.3&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.4&#39;</span>
<span class="c1"># command to install dependencies</span>
<span class="nt">install</span><span class="p">:</span> <span class="s">&quot;pip</span><span class="nv"> </span><span class="s">install</span><span class="nv"> </span><span class="s">-r</span><span class="nv"> </span><span class="s">requirements.txt&quot;</span>
<span class="c1"># command to run tests</span>
<span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py.test</span>
</pre></div>


<p>上面的 <code>.travis.yml</code>  会创建 Python 2.6 - Python 3.4  这 4 个 独立的 Python 测试环境。 在每个环境里，通过 <code>pip install -r requirements.txt</code> 安装项目所依赖的 Python Package。 </p>
<p><code>script</code> 用于指定用来执行单元测试的命令。这里我们使用的是  <code>py.test</code>， 根据个人喜好，你也可以选择 <code>nosetest</code>, <code>make test</code>, <code>python setup.py tetst</code> ... 对于 Python 项目， Travis CI 会自动安装 <code>nose</code>, <code>pytest</code>, <code>mock</code> 这几个常用的测试库。 </p>
<p>对于更加复杂的项目， 我们也可以指定多个 <code>install</code>  命令。
例如：</p>
<div class="highlight snippet"><pre><span></span><span class="nt">install</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install django==$DJANGO_VERSION</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -e .</span>
<span class="l l-Scalar l-Scalar-Plain">env： DJANGO_VERSION=1.7 SECRET_KEY=&quot;XXXXXXX&quot; FOO=&quot;foo&quot;</span>
</pre></div>


<p>上面的配置除了安装 requirements.txt 所罗列的 Python Package 外， 还会以 <code>develop</code> 模式 安装项目根目录下的 <code>setup.py</code>， 并根据 <code>DJANGO_VERSION</code> 这个环境变量，安装指定版本的 Django 。</p>
<p>如果， <code>env</code> 指定了多组环境变量， Travis CI 会将 各个版本的 Python 和环境变量组 一一组合。 下面的配置就会生成  4X3， 共12个测试环境。</p>
<div class="highlight snippet"><pre><span></span><span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.7&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.6&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.3&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.4&#39;</span>
<span class="nt">install</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install django==$DJANGO_VERSION</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -e .</span>
<span class="nt">env</span><span class="p">:</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.7</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.6</span>
 <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.5</span>
</pre></div>


<p><strong>注</strong>： 在 <code>env</code> 列表里， 每一行代表一组环境变量。多个环境变量间用空格隔开。</p>
<p>当我们想在每个测试环境中都设置一些环境变量时， 我们就要把 <code>env</code> 列表显式地拆分成 <code>matrix</code> 和 <code>global</code> 两个子列表。 <code>global</code> 子列表 里的环境变量不参与测试环境的组合。
 例：</p>
<div class="highlight snippet"><pre><span></span><span class="nt">env</span><span class="p">:</span>
  <span class="nt">matrix</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.7</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.6</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.5</span>
  <span class="nt">global</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">SECRET_KEY=&quot;XXXXXXX&quot;</span>
</pre></div>


<p>有时， 难免会遇到一些无效的测试环境组合， 比如 Django 1.7 就不支持 Python 2.6。 这种情况下， 可以用 <code>matrix.exclude</code> 来排除某些特殊的组合：</p>
<div class="highlight snippet"><pre><span></span><span class="nt">matrix</span><span class="p">:</span>
  <span class="nt">exclude</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">python</span><span class="p">:</span> <span class="s">&#39;2.6&#39;</span>
    <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.7</span>
</pre></div>


<p>总的来说，<code>.travis.yml</code> 的配置还是简明又不失灵活的， 用的也是标准的 <code>YAML</code> 语法。如果对 <code>YAML</code> 不熟， 建议上手Travis CI前，可以先找一份简明的 <code>YAML</code> 语法说明学习一下， 会起到事半功倍的效果。如果你的 <code>.travis.yml</code> 存在语法错误，可以用 <a href="http://lint.travis-ci.org/">Travis WebLint</a> 来作调试和语法检查。</p>
<p>最后 ， 附上我在 <a href="https://github.com/glasslion/django-qiniu-storage">django-qiniu-storage</a> 项目中所使用 <code>.travis.yml</code> 以资参考。</p>
<div class="highlight snippet"><pre><span></span><span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python</span>
<span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.7&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;2.6&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.3&#39;</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.4&#39;</span>
<span class="nt">install</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -r requirements.txt</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install django==$DJANGO_VERSION</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pip install -e .</span>
<span class="nt">script</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">py.test tests/test_storage.py</span>
<span class="nt">env</span><span class="p">:</span>
  <span class="nt">matrix</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.7</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.6</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.5</span>
  <span class="nt">global</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">USING_TRAVIS=YES</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">QINIU_BUCKET_NAME=django-qiniu-storage</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">QINIU_BUCKET_DOMAIN=django-qiniu-storage.qiniudn.com</span>
  <span class="p p-Indicator">-</span> <span class="nt">secure</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">QVYe9vITrCQw924X7h0vYfHwSDGs6QTaHitM2M31hVkYdBWnYMQZcyW1b5DUcXIOot/Z9+1av77tHgh2nXPA34uR7OIzO+LTtmByEE4fOQwJPDkWvJmF63z6B3eRwH20RPg7sBhzQqEK8KPApTiVjRxw5qsf8yp3+V5aozrKAOg=</span>
<span class="nt">matrix</span><span class="p">:</span>
  <span class="nt">exclude</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">python</span><span class="p">:</span> <span class="s">&#39;2.6&#39;</span>
    <span class="nt">env</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DJANGO_VERSION=1.7</span>
</pre></div>
    </div><!-- .entry-content -->
    <footer class="entry-meta entry-footer">
      <span class="cat-links">Posted in 
        <a href="https://wing2south.com/category/python.html" rel="category">Python</a>
      </span>
      <span class="tags-links">Tagged 
      </span>
    </footer><!-- .entry-meta -->

  </article><!-- #post-## -->


  <nav class="navigation post-navigation" role="navigation">
    <div class="nav-links">
        <div class="nav-previous">
          <h2>Previous post</h2>
          <a href="https://wing2south.com/post/django-raw-sql/" rel="prev">闲话 Django Raw SQL</a>
        </div>
        <div class="nav-next">
          <h2>Next post</h2>
          <a href="https://wing2south.com/post/rest-client-tips/" rel="next">REST Client 拾遗</a>
        </div>
    </div><!-- .nav-links -->
  </nav><!-- .navigation -->

<div id="comments" class="comments-area">
  <hr />
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'wing2south';
    var disqus_identifier = "post/travisci-multi-python-test-env/";
    var disqus_title = "用 Travis CI 定制多样化的 Python 测试环境";
    var disqus_url = "https://wing2south.com/post/travisci-multi-python-test-env/";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>
</div>  <!-- #comments -->
          </main><!-- #main -->
        </div><!-- #primary -->
      </div><!-- #content -->

      <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
          <div class="site-copyright">© 2019 <a href="https://wing2south.com" rel="home">翼图南</a></div>
          <div class="site-credit">Powered by <a href="http://blog.getpelican.com/">Pelican</a> &amp;
          <a href="http://wordpress.org/themes/graphy">Graphy</a>, hosted on <a href="https://github.com/">GitHub</a>.</div>
        </div><!-- .site-info -->
      </footer><!-- #colophon -->

    </div><!-- #page -->

  <script type="text/javascript" src="https://wing2south.com/theme/js/navigation.js?1571737423.0"></script>
  <script type="text/javascript" src="https://wing2south.com/theme/js/skip-link-focus-fix.js?1571737423.0"></script>
  <script type="text/javascript" src="https://wing2south.com/theme/js/google-search.js?1571737423.0"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42951023-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>