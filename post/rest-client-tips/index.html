<!DOCTYPE html>
<!--[if IE 8]>
<html class="ie8" lang="zh">
<![endif]-->
<!--[if !(IE 8) ]><!-->
<html lang="zh"><!--<![endif]-->
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>翼图南</title>
        <link rel ="alternate" type="application/atom+xml"
                               title="翼图南 — Flux RSS"
                               href="https://wing2south.com/feeds/all.atom.xml" />
      <link rel="stylesheet" id="graphy-fonts-css" href="http://fonts.proxy.ustclug.org/css?family=Lato:400,700,400italic,700italic|Bitter:400&amp;subset=latin,latin-ext" type="text/css" media="all">
      <link rel="stylesheet" id="graphy-genericons-css" href="https://wing2south.com/theme/css/genericons.css" type="text/css" media="all">
      <link rel="stylesheet" href="https://wing2south.com/theme/css/style.min.css?1571737423.0">
      <link rel="stylesheet" href="https://wing2south.com/theme/css/typo.css?1571737423.0" type="text/css" media="all">

      <link rel="apple-touch-icon" sizes="57x57" href="/theme/icons/apple-touch-icon-57x57.png">
      <link rel="apple-touch-icon" sizes="60x60" href="/theme/icons/apple-touch-icon-60x60.png">
      <link rel="apple-touch-icon" sizes="72x72" href="/theme/icons/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="76x76" href="/theme/icons/apple-touch-icon-76x76.png">
      <link rel="apple-touch-icon" sizes="114x114" href="/theme/icons/apple-touch-icon-114x114.png">
      <link rel="apple-touch-icon" sizes="120x120" href="/theme/icons/apple-touch-icon-120x120.png">
      <link rel="apple-touch-icon" sizes="144x144" href="/theme/icons/apple-touch-icon-144x144.png">
      <link rel="apple-touch-icon" sizes="152x152" href="/theme/icons/apple-touch-icon-152x152.png">
      <link rel="apple-touch-icon" sizes="180x180" href="/theme/icons/apple-touch-icon-180x180.png">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-32x32.png" sizes="32x32">
      <link rel="icon" type="image/png" href="/theme/icons/android-chrome-192x192.png" sizes="192x192">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-96x96.png" sizes="96x96">
      <link rel="icon" type="image/png" href="/theme/icons/favicon-16x16.png" sizes="16x16">
      <link rel="manifest" href="/theme/icons/manifest.json">
      <link rel="shortcut icon" href="/theme/icons/favicon.ico">
      <meta name="msapplication-TileColor" content="#da532c">
      <meta name="msapplication-TileImage" content="/theme/icons/mstile-144x144.png">
      <meta name="msapplication-config" content="/theme/icons/browserconfig.xml">
      <meta name="theme-color" content="#ffffff">
  </head>


  <body class="home blog no-sidebar footer-0 has-avatars">
    <div id="page" class="hfeed site">
      <header id="masthead" class="site-header" role="banner">
        <div class="site-branding">
          <h1 class="site-title"><a href="/" rel="home">翼图南</a></h1>
          <div class="site-description">故九萬里，則風斯在下矣，而後乃今培風；背負青天而莫之夭閼者，而後乃今將圖南</div>
        </div>

        <div class="main-navigation-wrapper">
          <nav id="site-navigation" class="main-navigation" role="navigation">
            <h1 class="menu-toggle">Menu</h1>
            <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
            <div class="menu">
              <ul>
                <li class="current_page_item">
                  <a href="/">Home</a>
                </li>
                    <li><a href="https://wing2south.com/pages/gpg.html">GPG</a></li>
                  <li><a href="/cv.htm">CV</a></li>
                <li class="page_item page_item_has_children">
                  <a href="#">Categories</a>
                  <ul class="children">
                      <li class="page_item">
                        <a href="/category/code.html">Code</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/devops.html">Devops</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/django.html">Django</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/fen-xiang-lian-jie.html">分享链接</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/ji-qi-xue-xi.html">机器学习</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/machinelearning.html">MachineLearning</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/others.html">Others</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/productivity.html">Productivity</a>
                      </li>
                      <li class="page_item">
                        <a href="/category/python.html">Python</a>
                      </li>
                  </ul>
                </li>
                <li class="page_item">
                  <a href="/tags.html">Tags</a>
                </li>
                <li class="page_item page_item_has_children">
                  <a href="#">Social</a>
                  <ul class="children">
                      <li class="page_item">
                        <a href="https://twitter.com/glasslion">Twitter</a>
                      </li>
                      <li class="page_item">
                        <a href="https://github.com/glasslion">GitHub</a>
                      </li>
                      <li class="page_item">
                        <a href="http://stackoverflow.com/users/1093020/leonardo-z">StackOverflow</a>
                      </li>
                      <li class="page_item">
                        <a href="/images/wechat.jpg">微信二维码</a>
                      </li>
                  </ul>
                </li>
                  <li class="page_item">
                    <a href="https://wing2south.com/feeds/all.atom.xml" rel="alternate">Feed</a>
                  </li>
              </ul>
            </div><!-- .menu -->
            <form role="search" method="get" class="search-form" onsubmit="return google_search()">
            <label>
              <span class="screen-reader-text">Search for:</span>
              <input type="search" class="search-field" placeholder="Search …" value="" name="q" id="google_q" title="Search for:">
            </label>
            <input type="submit" class="search-submit" value="Search">
          </form>
          </nav><!-- #site-navigation -->
        </div>
      </header><!-- #masthead -->

      <div id="content" class="site-content">
        <div id="primary" class="content-area">
          <main id="main" class="site-main" role="main">

  <article class="post hentry typo">
    <header class="entry-header">
      <h1 class="entry-title">REST Client 拾遗</h1>
        <div class="entry-meta">
          <span class="posted-on">Posted on 
            <a href="https://wing2south.com/archives/2015/02/" rel="bookmark">
              <time class="entry-date published" datetime="2015-02-27T20:15:00+08:00">Feb 27, 2015</time>
            </a>
          </span>
          <span class="byline">by 
            <span class="author vcard">
              <a class="url fn n" href="https://wing2south.com/post/rest-client-tips/">Leonardo Zhou</a>
            </span>
          </span>
          <span class="comments-link">· <a href="https://wing2south.com/post/rest-client-tips/#comments" title="Comment on More Tags">Leave a comment</a>
          </span>
        </div><!-- .entry-meta -->
    </header>

    <div class="entry-content">
      <p>Restful Service 早已不是什么新鲜玩意。 国内很多公司都提供基于 REST 的服务， 其中不少还有官方提供的 多语言 SDK。先不论这些 REST API 的设计， 那些SDK/REST Client 往往并不好用， 在 github 上也能找到大量改良的 fork。这里就分享一些我关于写好 REST Client 的愚见。</p>
<h3>REST Client 不是 url 拼接器</h3>
<p>相当多的 REST Client 说简单了，就做一件事:</p>
<div class="highlight snippet"><pre><span></span><span class="kn">import</span> <span class="nn">request</span>
<span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>


<p>REST Client 返回给用户的应该是解析好的，有意义的对象， 而不是原始的 JSON。这些对象应该提供一些数据操作接口，可以方便地修改对象所对应的数据。 </p>
<p>以新浪微博 API 为例， 官方推荐的 <a href="https://github.com/michaelliao/sinaweibopy">Python SDK</a> 只是把 <code>HTTP GET： statuses/user_timeline</code> 这个请求包装成了 <code>client.statuses.user_timeline.get()</code> 这样的函数调用。这样的 Client 写起来很简单， 单个文件就可以搞定， 但对用户却不友好。譬如收藏评论这样简单的操作， 用户也要不断去翻 新浪微博 API 文档， 并手动拼接出正确的 API URL。</p>
<p>相比之下， 另一个微博 <a href="https://github.com/wuyuntao/weibopy">Client</a>， 只对 API 返回的实体做了简单的抽象，就已经极大提高 Client 的易用性。扫一眼下面的代码， 不看文档， 我也知道怎样用代码刷微博了。
 Anyway， REST API 是给机器用的， REST Client 是给人用的。</p>
<p>e.g.</p>
<div class="highlight snippet"><pre><span></span># <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">wuyuntao</span><span class="o">/</span><span class="nv">weibopy</span>
<span class="nv">class</span> <span class="nv">Comments</span><span class="ss">(</span><span class="nv">Model</span><span class="ss">)</span>:
    <span class="nv">def</span> <span class="nv">destroy</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">destroy_status</span><span class="ss">(</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">retweet</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">retweet</span><span class="ss">(</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">retweets</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">retweets</span><span class="ss">(</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">favorite</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">create_favorite</span><span class="ss">(</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>

<span class="nv">class</span> <span class="nv">User</span><span class="ss">(</span><span class="nv">Model</span><span class="ss">)</span>:

    <span class="nv">def</span> <span class="nv">timeline</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">user_timeline</span><span class="ss">(</span><span class="nv">user_id</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">id</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">friends</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">friends</span><span class="ss">(</span><span class="nv">user_id</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">id</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">followers</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">followers</span><span class="ss">(</span><span class="nv">user_id</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">id</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">follow</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">create_friendship</span><span class="ss">(</span><span class="nv">user_id</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>
        <span class="nv">self</span>.<span class="nv">following</span> <span class="o">=</span> <span class="nv">True</span>

    <span class="nv">def</span> <span class="nv">unfollow</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">destroy_friendship</span><span class="ss">(</span><span class="nv">user_id</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">id</span><span class="ss">)</span>
        <span class="nv">self</span>.<span class="nv">following</span> <span class="o">=</span> <span class="nv">False</span>

    <span class="nv">def</span> <span class="nv">lists_memberships</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">lists_memberships</span><span class="ss">(</span><span class="nv">user</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">screen_name</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">lists_subscriptions</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">lists_subscriptions</span><span class="ss">(</span><span class="nv">user</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">screen_name</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">lists</span><span class="ss">(</span><span class="nv">self</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>:
        <span class="k">return</span> <span class="nv">self</span>.<span class="nv">_api</span>.<span class="nv">lists</span><span class="ss">(</span><span class="nv">user</span><span class="o">=</span><span class="nv">self</span>.<span class="nv">screen_name</span>, <span class="o">*</span><span class="nv">args</span>, <span class="o">**</span><span class="nv">kargs</span><span class="ss">)</span>
</pre></div>


<h3>没有充分利用缓存</h3>
<p>成熟的 REST 服务往往会利用缓存来提高响应速度。许多多 REST 服务（例如 github， heroku, 阿里云 OSS）使用 <code>If-Modified-Since</code>(Last-Modified) 和 <code>If-None-Match</code>(ETag) 这两个 HTTP 头来标示缓存信息。一个好的 REST Client 应当在请求时向 Server 端提供这些 HTTP 头。</p>
<p>e.g</p>
<div class="highlight snippet"><pre><span></span># <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">sigmavirus24</span><span class="o">/</span><span class="nv">github3</span>.<span class="nv">py</span>
<span class="nv">def</span> <span class="nv">refresh</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">conditional</span><span class="o">=</span><span class="nv">False</span><span class="ss">)</span>:
    <span class="nv">headers</span> <span class="o">=</span> {}
    <span class="k">if</span> <span class="nv">conditional</span>:
        <span class="k">if</span> <span class="nv">self</span>.<span class="nv">last_modified</span>:
            <span class="nv">headers</span>[<span class="s1">&#39;</span><span class="s">If-Modified-Since</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">self</span>.<span class="nv">last_modified</span>
        <span class="nv">elif</span> <span class="nv">self</span>.<span class="nv">etag</span>:
            <span class="nv">headers</span>[<span class="s1">&#39;</span><span class="s">If-None-Match</span><span class="s1">&#39;</span>] <span class="o">=</span> <span class="nv">self</span>.<span class="nv">etag</span>
</pre></div>


<h3>跨域问题</h3>
<p>出于安全考虑， 浏览器会限制脚本中发起的跨站请求。绕过这个限制的方法也不少，比如 iframe, JSONP, CORS... 其中<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS">跨源资源共享</a>（Cross-Origin Resource Sharing / CORS) 是比较主流的， 也是 W3C 推荐的一种做法。本文篇幅有限， 其细节可以参考前文所给的链接，接下来让我们专心黑 IE。
其他浏览器都是在 <code>XMLHttpRequest</code> 对象上实现了 CORS。 唯独微软在 IE8-IE9 里引入了一个新的对象 <code>XDomainRequest</code>， 专门处理CORS 请求。 这还是个小坑， 前端可以很容易绕过。最要命的是在 IE10 以前，<code>XDomainRequest</code> 只支持 GET 和 POST 方法, 而且无法自定义 HTTP Header。于是 PUT， DELETE 方法是不能用了， 要设置 <code>Content-type</code> 为 <code>application/json</code> 也不行了。当然解决办法是有的， 比如使用 <a href="https://github.com/jpillora/xdomain">XDomain</a>。但这些方法都需要对 Server 端做一定的更改，无法完全在 Client 端加以解决。</p>
<p>值得一提的是， Django REST Framework 为此原生提供了一种很简单的 <a href="http://www.django-rest-framework.org/topics/browser-enhancements/">workaround</a>。 只要设置了 <code>X-HTTP-Method-Override</code> 头，DRF 就会将那些本来是 POST 的请求，当作指定的方法处理。</p>
<p>e.g.</p>
<div class="highlight snippet"><pre><span></span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/myresource/&#39;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;X-HTTP-Method-Override&#39;</span><span class="o">:</span> <span class="s1">&#39;PATCH&#39;</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">});</span>
</pre></div>


<p>尽管跨域问题只存在浏览器端， 但所有的 Client 也会面临类似的问题： 一些企业内部网络由于代理，防火墙的限制， 无法使用某些特定的 HTTP 方法。 因此 REST Client 在这方面下点功夫还是很有必要。</p>
<h2>Finally</h2>
<p>在写 REST Client 时会遇到的那些痛点, 很多时候是无法光靠 Client 自身去解决的, 需要服务器端的配合。换个角度看的话，那么Server 端的实现可只能称之为失败。因此我建议那些负责 REST 服务端程序员也去亲自写一下对应 Client 端的代码。对于后端程序员来说， 这并不需要多少前端知识， 你完全可以使用和 Server 端相同的编程语言，我信心这会 带来不少启发。</p>
    </div><!-- .entry-content -->
    <footer class="entry-meta entry-footer">
      <span class="cat-links">Posted in 
        <a href="https://wing2south.com/category/python.html" rel="category">Python</a>
      </span>
      <span class="tags-links">Tagged 
          <a href="https://wing2south.com/tag/rest.html" rel="tag">rest</a>
      </span>
    </footer><!-- .entry-meta -->

  </article><!-- #post-## -->


  <nav class="navigation post-navigation" role="navigation">
    <div class="nav-links">
        <div class="nav-previous">
          <h2>Previous post</h2>
          <a href="https://wing2south.com/post/travisci-multi-python-test-env/" rel="prev">用 Travis CI 定制多样化的 Python 测试环境</a>
        </div>
        <div class="nav-next">
          <h2>Next post</h2>
          <a href="https://wing2south.com/post/advanced-pelican-publish-github-travis/" rel="next">利用 Travis CI + Github 给静态博客加上草稿和编辑预览功能</a>
        </div>
    </div><!-- .nav-links -->
  </nav><!-- .navigation -->

<div id="comments" class="comments-area">
  <hr />
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'wing2south';
    var disqus_identifier = "post/rest-client-tips/";
    var disqus_title = "REST Client 拾遗";
    var disqus_url = "https://wing2south.com/post/rest-client-tips/";
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus</a>.</noscript>
</div>  <!-- #comments -->
          </main><!-- #main -->
        </div><!-- #primary -->
      </div><!-- #content -->

      <footer id="colophon" class="site-footer" role="contentinfo">
            <div class="site-info">
          <div class="site-copyright">© 2019 <a href="https://wing2south.com" rel="home">翼图南</a></div>
          <div class="site-credit">Powered by <a href="http://blog.getpelican.com/">Pelican</a> &amp;
          <a href="http://wordpress.org/themes/graphy">Graphy</a>, hosted on <a href="https://github.com/">GitHub</a>.</div>
        </div><!-- .site-info -->
      </footer><!-- #colophon -->

    </div><!-- #page -->

  <script type="text/javascript" src="https://wing2south.com/theme/js/navigation.js?1571737423.0"></script>
  <script type="text/javascript" src="https://wing2south.com/theme/js/skip-link-focus-fix.js?1571737423.0"></script>
  <script type="text/javascript" src="https://wing2south.com/theme/js/google-search.js?1571737423.0"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42951023-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>